services:
  upload-service:
    build: ./upload-service
    ports:
      - 4567:4567

  caddy:
    image: caddy:latest
    ports:
      - "8443:8443"
    volumes:
      - ./upload-service/Caddyfile:/etc/caddy/Caddyfile
      - ./upload-service/data/data:/data
      - ./upload-service/data/config:/config

  node:
    image: ghcr.io/xmtp/node-go:main
    platform: linux/amd64
    command:
      - --store.enable
      - --store.db-connection-string=postgres://postgres:xmtp@db:5432/postgres?sslmode=disable
      - --store.reader-db-connection-string=postgres://postgres:xmtp@db:5432/postgres?sslmode=disable
      - --mls-store.db-connection-string=postgres://postgres:xmtp@mlsdb:5432/postgres?sslmode=disable
      - --mls-validation.grpc-address=validation:50051
      - --api.enable-mls
      - --wait-for-db=30s
      - --api.authn.enable
    ports:
      # Remapping because the Android emulator uses port 5555 for ADB (Android Debug Bridge) connections
      - 9001:5555
      - 9002:5556
    depends_on:
      - db
      - mlsdb
      - validation

  validation:
    image: ghcr.io/xmtp/mls-validation-service:main
    platform: linux/amd64

  history-server:
    image: ghcr.io/xmtp/message-history-server:main
    platform: linux/amd64
    ports:
      - 5558:5558

  db:
    image: postgres:13
    environment:
      POSTGRES_PASSWORD: xmtp

  mlsdb:
    image: postgres:13
    environment:
      POSTGRES_PASSWORD: xmtp
